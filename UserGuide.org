
#+TITLE:  OpTool User Guide
#+AUTHOR: Carsten Dominik & Michiel Min
#+DATE:   July 2020, version 0.9.8

* Introduction

This tool allows to produce complex dust opacities right from the
command line. It is derived[fn:1] from Michiel Min's [[https://dianaproject.wp.st-andrews.ac.uk/data-results-downloads/fortran-package/][OpacityTool]] for the
[[https://dianaproject.wp.st-andrews.ac.uk/][DIANA]] program, and committed to its simplicity.

[fn:1] For another derivative of OpacityTool with a different set of
applications, check out [[https://github.com/charlenelefevre/SIGMA][SIGMA]], the /Simple Icy Grain Model for
Aggregates/, by Lef√©vre et al. (2020).


** Capabilities

- stand-alone tool, fully command line driven, no input files need to
  be edited
- flexible command line interface to specify input in a compact and
  simple way
- full scattering matrix output in several formats, including for
  RADMC-3D
- combining materials through mixing into a complex grain with
  porosity
- DHS method to model shape effects and low-porosity aggregates
- a useful collection of compiled-in materials for standard applications
  in astronomy
- an easy way to use external refractive index data for more
  specialized applications
- multi-core support through OpenMP to make even complex computations
  very fast

** Terms of use

The code doing the real work of =optool= was adopted and modified from
[[https://dianaproject.wp.st-andrews.ac.uk/data-results-downloads/fortran-package/][OpacityTool]]. I focused on the interface, on simplicity, and a clean
set of conventions. If you are using this tool, you should point to
the [[https://github.com/cdominik/optool.git][GitHub repository]] and give credit to the papers describing the
methods used to compute the opacities, as well as to the original
laboratory papers that published the refractive index measurements.

- =optool=: [[https://github.com/cdominik/optool.git][=https://github.com/cdominik/optool.git=]]
- DHS model for irregular grains:  [[https://ui.adsabs.harvard.edu/abs/2005A%26A...432..909M][Min et al. 2005, A&A, 432, 909]]
- DIANA standard Opacities: [[https://ui.adsabs.harvard.edu/abs/2016A%26A...586A.103W][Woitke, Min et al. 2016]]
- Third party software: [[https://ui.adsabs.harvard.edu/abs/1981ApOpt..20.3657T][Toon et al. 1981, Applied Optics 20, 3657]]
- References to [[#builtin-materials][refractive index data]] used in your particular
  application.

* Examples
A simple grain made only of the default pyroxene, for the default
grain size distribution ($a^{-3.5}$ powerlaw from 0.05 to 3000\mu{}m),
on the default wavelength grid (0.05\mu{}m to 1cm).
: optool pyr

Reproduce the DIANA standard dust model, using a specific pyroxene
(70% Mg) and carbon, in a mass ratio 0.87/0.13, and with a porosity of
25%.
: optool pyr-mg70 0.87  c 0.13  -p 0.25

List the built-in materials
: optool -c

Add an ice mantle that is 20% of the core mass
: optool pyr-mg70 0.87  c 0.13  -m ice-w 0.2  -p 0.25

Like the previous example, but use ice refractive index data from a
separate file.

: optool pyr-mg70 0.87  c 0.13  -p 0.25  -m lnkfiles/ice_hudgins.dat 0.2

Pure ice grains in a narrow size distribution from 1 to 3 microns,
with 15 sample sizes following an $f(a)\propto a^{-2.5}$ powerlaw size
distribution. Also, restrict the wavelength range to 10-100\mu{}m.

: optool ice -a 1 3 2.5 15  -l 10 100

Represent the default dust model (DIANA, you also get this when you do
not give any materials at all) in 42 grain sizes, and produce input
files for RADMC-3D, one for each grain size, with full scattering
matrix, chopping 3 degrees from the scattering peak.

: optool -na 42 -d -s -radmc -chop 3

Use the Bruggeman rule to blend refractive index data of three
orientations of a crystaline material into a file =blended.lnk=,
using the wavelength grid given in one of those files

: optool -b gra_x.lnk 0.33 gra_y.lnk 0.33 gra_z.lnk 0.33 -l gra_x.lnk

\clearpage
* Compiling =optool=
:PROPERTIES:
:CUSTOM_ID: compilation
:END:
On most systems, you can download and compile =optool= with these
simple steps, using the freely available GNU FORTRAN compiler
[[https://gcc.gnu.org/wiki/GFortran][=gfortran=]].

: git clone https://github.com/cdominik/optool.git
: cd optool
: make

The executable is called =optool=, and you should put it on your
execution path.  To use the [[https://software.intel.com/content/www/us/en/develop/tools/compilers/fortran-compilers.html][Intel fortran compiler]], to use multiple
cores[fn:2] for speed, or to be able to write FITS files[fn:3], use
one or more of the following parameters during compilation:

: make ifort=true        # use the Intel fortran compiler iFort
: make multi=true        # enable multicore support
: make  fits=true        # add support for writing FITS files

[fn:2] If you do turn multicore support on, please also run "=make
selftest=" to test if everything works properly.  I have had problems
with the OpenMP setup of an older version of =gfortran=.
[fn:3] This requires the [[https://heasarc.gsfc.nasa.gov/fitsio/][=cfitsio=]] library to be installed on your system.

* Command line options

+ =-h= :: Show a compact help message about command line options.

** Grain composition and geometry
  
+ =-c= :: List available built-in materials (the keys for the *-c* and
  *-m* options).

+ =[-c] KEY-or-FILE1 [MFRAC] [KEY-or-FILE2 [MFRAC]] ...= ::

  Specify a material to include into the grain.  =KEYorFILE= can be
  the [[#builtin-materials][key for a builtin material]], or the path to the correct =lnk=
  file. =MFRAC= is the /mass/ fraction of the material. You can give
  up to 10 materials to build up the grain.  All materials will be
  mixed together using the Bruggeman rule, and vacuum can be included
  through the porosity. A *-c* switch before each =KEY-or-FILE= is
  optional.

+ =-m KEY-or-FILE [MFRAC]= ::

  Like *-c*, but use this material as a mantle material that will be
  mixed in using the Maxwell-Garnett rule instead of the Bruggeman
  rule.  Only one *-m* switch is allowed, and it needs to come after
  all *-c* specifications.
  
+ =-p POROSITY [P_MANTLE]= ::

  Porosity, the /volume/ fraction of vacuum, a number smaller than 1.
  The default is 0.  A single value will apply to both core and
  mantle, but a second value will be specific for the mantle (and may
  be 0).
  
+ =-fmax VHMAX= ::

  Maximum /volume/ fraction of the inner hole for the DHS approach.
  The default is 0.8.  Zero means to use solid spheres, i.e. perfectly
  regular grains.


** Grain size distribution
+ =-a AMIN AMAX [APOW [NA]]= ::

  Specify minimum and maximum grain radius, and optionally the size
  distribution powerlaw and the number of size bins.  You can also use
  options to set individual values with *-amin*, *-amax*, *-apow*,
  *-na*. The defaults are 0.05 \mu{}m, 3000 \mu{}m, 3.5, and /10 per
  size decade with a fixed minimum of 5/, respectively.

** Wavelength grid

+ =-l LMIN LMAX [NLAM]= ::

  Minimum and maximum wavelength and optionally the number of
  wavelengths points for the construction of the wavelength grid.  The
  default values are 0.05 \mu{}m, 10000 \mu{}m, and 300, respectively.
  Use the options *-lmin*, *-lmax*, and *-nlam* (or *-nl*) to set
  individual values.

+ =-l FILE= ::

  Read the wavelength grid from the first column of =FILE=.  The first
  number in the file must be the number of grid points. So this could
  be an [[#lnk-files][=lnk=]] file.

** Controlling the output

The standard output is the file =dustkappa.dat=, with the opacities
and the asymmetry parameter /g/. The following options control and
extend the [[#output-files][output]].

+ =-o [DIR]= ::

  Put the output files in directory =DIR= instead of the current
  working directory. =./output= will be used if =DIR= is not
  specified.

+ =-s [NANG]= ::

  Include the full scattering matrix in the output. =NANG= can
  optionally specify the number of equally-spaced [[#angular-grid][angular grid points]]
  to cover the range of angles between 0 and 180 degrees.  The default
  for =NANG= is 180 and should normally not be changed.

+ =-chop [NDEG]= ::

  Cut out the first =NDEG= (2 if unspecified) degrees of the [[#forward-scattering-peak][forward
  scattering peak]] and compensate by a reduction in the scattering
  cross section.

+ =-d [NSUB]= ::

  Divide the computation up into =NA= parts to produce a file for each
  grain size.  Each size will actually be an average over a small
  range of =NSUB= grains around the real size, to smear out resonances.
  The default for =NSUB= is 5.

+ =-fits= ::

  Write =dustkappa.fits= with the absorption cross sections and
  scattering matrix elements, instead of ASCII output.  With the =-d=
  switch, =NA= files will be written.

+ =-radmc [LABEL]= ::

  RADMC-3D uses a different angular grid and normalization for the
  [[#normalization][scattering matrix]], so the output has to be adapted for it.  The
  extension of the files will be changed to =.inp=, and if you specify
  =LABEL=, it will be used in the file name(s).

+ =-t [TMIN [TMAX [NT]]]= ::
  
  Compute mean opacities per g of dust mass, \kappa_Planck and
  \kappa_Rosseland, in the given temperature interval, in =nt=
  logarithmic steps, with output to =dustkapmean.dat=. The parameters
  default to 10K, 10000K, and 200, respectively.



** Other options
+ =-b= ::

  Only blend the materials using the Bruggeman rule and write the
  output to =blended.lnk=.

+ =-q= ::
  Quiet. Reduce the amount of text written to STDOUT to a minimum.

* Material properties
=optool= needs refractive index data to work.  For your convenience, a
useful list of materials is compiled into =optool=, but you can also
find and use other data.  No matter where the data is from, you should
/always/ cite the original laboratory papers.

** Built-in materials
:PROPERTIES:
:CUSTOM_ID: builtin-materials
:END:

To access one of the built-in materials, specify the corresponding key
string like =pyr-mg70= instead of the path to an =lnk= file. In each
material class I have selected a useful default, accessible with an
even simpler generic key.

#+ATTR_LATEX: :font \small\sf :align llllrrrlHH
| *-c Key* | *-c Key*   | *Material*              | *State* |   \rho | \lambda_min | \lambda_max | *Reference*  | *Comment*    | *File*                      |
| generic  | full key   |                         |         | g/cm^3 |      \mu{}m |      \mu{}m |              |              |                             |
|----------+------------+-------------------------+---------+--------+-------------+-------------+--------------+--------------+-----------------------------|
|          | pyr-mg100  | MgSiO_3                 | amorph  |   2.71 |         0.2 |         500 | [[https://ui.adsabs.harvard.edu/abs/1995A%26A...300..503D/abstract][Dorschner+95]] |              | [[file:lnk_data/pyr-mg100-Dorschner1995.lnk][pyr-mg100-Dorschner1995.lnk]] |
|          | pyr-mg95   | Mg_{0.95}Fe_{0.05}SiO_3 | amorph  |   2.74 |         0.2 |         500 | [[https://ui.adsabs.harvard.edu/abs/1995A%26A...300..503D/abstract][Dorschner+95]] |              | [[file:lnk_data/pyr-mg95-Dorschner1995.lnk][pyr-mg95-Dorschner1995.lnk]]  |
|          | pyr-mg80   | Mg_{0.8}Fe_{0.2}SiO_3   | amorph  |    2.9 |         0.2 |         500 | [[https://ui.adsabs.harvard.edu/abs/1995A%26A...300..503D/abstract][Dorschner+95]] | \rho interp. | [[file:lnk_data/pyr-mg80-Dorschner1995.lnk][pyr-mg80-Dorschner1995.lnk]]  |
| pyr      | pyr-mg70   | Mg_{0.7}Fe_{0.3}SiO_3   | amorph  |   3.01 |         0.2 |         500 | [[https://ui.adsabs.harvard.edu/abs/1995A%26A...300..503D/abstract][Dorschner+95]] |              | [[file:lnk_data/pyr-mg70-Dorschner1995.lnk][pyr-mg70-Dorschner1995.lnk]]  |
|          | pyr-mg60   | Mg_{0.6}Fe_{0.4}SiO_3   | amorph  |    3.1 |         0.2 |         500 | [[https://ui.adsabs.harvard.edu/abs/1995A%26A...300..503D/abstract][Dorschner+95]] | \rho interp. | [[file:lnk_data/pyr-mg60-Dorschner1995.lnk][pyr-mg60-Dorschner1995.lnk]]  |
|          | pyr-mg50   | Mg_{0.5}Fe_{0.5}SiO_3   | amorph  |    3.2 |         0.2 |         500 | [[https://ui.adsabs.harvard.edu/abs/1995A%26A...300..503D/abstract][Dorschner+95]] |              | [[file:lnk_data/pyr-mg50-Dorschner1995.lnk][pyr-mg50-Dorschner1995.lnk]]  |
|          | pyr-mg40   | Mg_{0.4}Fe_{0.6}SiO_3   | amorph  |    3.3 |         0.2 |         500 | [[https://ui.adsabs.harvard.edu/abs/1995A%26A...300..503D/abstract][Dorschner+95]] | \rho interp. | [[file:lnk_data/pyr-mg40-Dorschner1995.lnk][pyr-mg40-Dorschner1995.lnk]]  |
| ens      | pyr-c-mg96 | Mg_{0.96}Fe_{0.04}SiO3  | cryst   |    2.8 |       *2.0* |        *99* | [[https://ui.adsabs.harvard.edu/abs/1998A%26A...339..904J][J√§ger+98]]     |              | [[file:lnk_data/pyr-c-mg96-JaÃàger1998.lnk][pyr-c-mg96-JaÃàger1998.lnk]]    |
|----------+------------+-------------------------+---------+--------+-------------+-------------+--------------+--------------+-----------------------------|
| ol       | ol-mg50    | MgFeSiO_4               | amorph  |   3.71 |         0.2 |         500 | [[https://ui.adsabs.harvard.edu/abs/1995A%26A...300..503D/abstract][Dorschner+95]] |              | [[file:lnk_data/ol-mg50-Dorschner1995.lnk][ol-mg50-Dorschner1995.lnk]]   |
|          | ol-mg40    | Mg_0.8 Fe_1.2 SiO_4     | amorph  |   3.71 |         0.2 |         500 | [[https://ui.adsabs.harvard.edu/abs/1995A%26A...300..503D/abstract][Dorschner+95]] | \rho ?       | [[file:lnk_data/ol-mg40-Dorschner1995.lnk][ol-mg40-Dorschner1995.lnk]]   |
| for      | ol-c-mg100 | Mg_2 SiO_4              | cryst   |   3.33 |       *3.0* |         250 | [[https://ui.adsabs.harvard.edu/abs/1974PhDT.......274S][Steyer+74]]    | switch out?  | [[file:lnk_data/ol-c-mg100-Steyer1974.lnk][ol-c-mg100-Steyer1974.lnk]]   |
|----------+------------+-------------------------+---------+--------+-------------+-------------+--------------+--------------+-----------------------------|
| c        | c-z        | C                       | amorph? |    1.8 |        0.05 |         1e4 | [[https://ui.adsabs.harvard.edu/abs/1996MNRAS.282.1321Z/abstract][Zubko+96]]     |              | [[file:lnk_data/c-z-Zubko1996.lnk][c-z-Zubko1996.lnk]]           |
|          | c-p        | C                       | amorph  |    1.8 |        0.11 |         800 | [[https://ui.adsabs.harvard.edu/abs/1993A%26A...279..577P/abstract][Preibisch+93]] |              | [[file:lnk_data/c-p-Preibisch1993.lnk][c-p-Preibisch1993.lnk]]       |
| gra      | c-gra      | C graphite              | cryst   |  2.16? |       0.001 |        1000 | XXX+1900     | FIXME        |                             |
|          | c-org      | CHON organics           | amorph  |    1.4 |         0.1 |         1e5 | Henning+1900 | FIXME        |                             |
|          | c-nano     | C nano-diamond          | cryst   |    2.3 |        0.02 |       *110* | [[https://ui.adsabs.harvard.edu/abs/2004A%26A...423..983M][Mutschke+04]]  |              | [[file:lnk_data/nano-diam-Mutschke2004.lnk][nano-diam-Mutschke2004.lnk]]  |
|----------+------------+-------------------------+---------+--------+-------------+-------------+--------------+--------------+-----------------------------|
| ice      | ice-w      | Water ice               | cryst   |   0.92 |        0.04 |         2e6 | [[https://ui.adsabs.harvard.edu/abs/2008JGRD..11314220W/abstract][Warren+08]]    |              | [[file:lnk_data/ice-w-Warren2008.lnk][ice-w-Warren2008.lnk]]        |
|----------+------------+-------------------------+---------+--------+-------------+-------------+--------------+--------------+-----------------------------|
| iron     | fe-c       | Fe                      | metal   |   7.87 |         0.1 |         1e5 | [[https://ui.adsabs.harvard.edu/abs/1996A%26A...311..291H][Henning+96]]   |              | [[file:lnk_data/fe-c-Henning1996.lnk][fe-c-Henning1996.lnk]]        |
|          | fes        | FeS                     | metal   |   4.83 |         0.1 |         1e5 | [[https://ui.adsabs.harvard.edu/abs/1996A%26A...311..291H][Henning+96]]   |              | [[file:lnk_data/fes-Henning1996.lnk][fes-Henning1996.lnk]]         |
|          | sic        | SiC                     | cryst   |   3.22 |       0.001 |        1000 | [[https://ui.adsabs.harvard.edu/abs/1993ApJ...402..441L][Draine93]]     |              | [[file:lnk_data/sic-Draine1993.lnk][sic-Draine1993.lnk]]          |
|----------+------------+-------------------------+---------+--------+-------------+-------------+--------------+--------------+-----------------------------|
| cor      | cor-c      | Al_{2}O_3               | cryst   |    4.0 |         0.5 |        *40* | [[https://ui.adsabs.harvard.edu/abs/1995Icar..114..203K][Koike+95]]     |              | [[file:lnk_data/cor-c-Koike1995.lnk][cor-c-Koike1995.lnk]]         |


*** COMMENT Options for more materials
These are under consideration.  One problem is the limited wavelengths
range....

One could make an argument for a whole mineralogy section, of
course.....  But there would be so many hard-to-remember keys....

For now, the cut we are making is good.
|     | ol-c-mg100-T295 | Mg_2 SiO_4      | crystalline  | 3.37 | *5.0* | [[https://ui.adsabs.harvard.edu/abs/2006MNRAS.370.1599S][Suto+2006]]     | switch out?     | ????                      |
| ??? | ice             | Water ice       | amorphous    |      |       |               |                 |                           |
| fes | fes             | FeS             | crystalline? | 4.83 | *10*  | [[https://ui.adsabs.harvard.edu/abs/1994ApJ...423L..71B][Begemann+1994]] | \rho guessed    | fes-Begemann1994.lnk      |
|     | fes-mg10        | Fe_0.9 Mg_0.1 S | crystalline? | 4.83 | *10*  | [[https://ui.adsabs.harvard.edu/abs/1994ApJ...423L..71B][Begemann+1994]] | \rho set to FeS | fes-mg10-Begemann1994.lnk |
|     | fes-mg50        | Fe_0.5 Mg_0.5 S | crystalline? | 4.83 | *10*  | [[https://ui.adsabs.harvard.edu/abs/1994ApJ...423L..71B][Begemann+1994]] | \rho set to FeS | fes-mg50-Begemann1994.lnk |
|-----+-----------------+-----------------+--------------+------+-------+---------------+-----------------+---------------------------|


** External refractory index files (=lnk= files)
:PROPERTIES:
:CUSTOM_ID: lnk-files
:END:

=optool= can use external refractive index data in files with the
following format:
- The file may start with several comment lines (lines starting with
  =!=, =#=, or =*=).
- The next line contains two numbers, the number of
  wavelengths $N_\lambda$ and the specific weight \rho of the material
  in g/cm^3
- Then follow three columns of data: \lambda[\mu{}m], and the real and
  imaginary parts of the refractive index, $n$ and $k$.

You can find refractive index data in the [[https://www.astro.uni-jena.de/Laboratory/Database/databases.html][Jena database]], and
associated with original papers in the literature. Don't forget to add
the line with $N_\lambda$ and \rho!  If for some reason it is not
convenient to add that line to the file, =optool= will count the lines
for you and you can specify the density after the mass fraction, like
this: =optool -c path/to/file.lnk 0.7 3.42=



* Output files
:PROPERTIES:
:CUSTOM_ID: output-files
:END:

- dustkappa.dat ::

  This is an ASCII file containing the basic opacity results. It
  starts with a comment section describing the dust model, followed by
  the format number (3, currently), followed by the number of
  wavelengths in the grid, both on lines by themselves.  Then follows
  a block with these columns:

  1. wavelength \lambda [micron]
  2. mass absorption cross section \kappa_abs [cm^2/g]
  3. mass scattering cross section \kappa_sca [cm^2/g]
  4. asymmetry parameter /g/

- dustkapscatmat.dat ::

  ASCII file with cross sections and full scattering matrix.  The
  comment section at the start of the file explains the structure. See
  [[#normalization][the appendix]] for information about the normalization of the
  scattering matrix.  And see the =-radmc= switch which will modify
  the output to make sure it can be used as an input file for
  [[http://www.ita.uni-heidelberg.de/~dullemond/software/radmc-3d/][RADMC-3D]].

- dustkappa.fits ::

  The FITS-file (ending in ‚Äô.fits‚Äô) is written instead of the ASCII
  output when using the =-fits= switch. It has two HDU blocks. The first
  block contains the cross sections per unit mass. This is a N_\lambda
  \times 4 matrix with these columns:

  1. wavelengths in [\mu{}m]
  2. mass extinction cross section \kappa_ext in [cm^2/g]
  3. mass absorption cross section \kappa_abs in [cm^2/g]
  4. mass scattering cross section \kappa_sca in [cm^2/g]

  The second HDU block contains the scattering matrix elements. It is
  a N_\lambda \times 6 \times N_ang matrix, containing the 6 elements
  of the scattering matrix for N_ang equidistant scattering angles
  from forward scattering (element 0) to backward scattering (element
  N_ang-1), for each wavelength value. The stored matrix elements are
  F_11, F_12, F_22, F_33, F_34, and F_44.

- dustkapmean.dat ::

  This file will only be written with the =-t= switch. It contains 3
  columns: (1) T [K], (2) \kappa_Planck, (3) \kappa_Ross, both in cm^2
  per gram of /dust/. Note that dust evaporation is not considered,
  and that a wide wavelengths coverage is needed for good results.

* Inspecting the computed optical properties

To try out =optool= you could use one of these commands

: make test             # for a simple size-integrated opacity computation
:     ... or ...
: make testdiv          # for opacities as a function of grain size

#+CAPTION: Screenshot of the plots created by running =ipython -i optool_plot.py=. Note that we plot the logarithm of the absolute value of the scattering matrix, in order to deal with range and sign issues.
#+ATTR_LATEX: :width 15cm :options angle=0
[[./misc/inspect.png]]

The commands will run =optool= with the standard DIANA material
properties, and then use the python script =optool_plot.py= to plot
the computed opacities.  You will get:
- a plot showing the opacities \kappa_abs, \kappa_sca, and \kappa_ext
  as a function of wavelength, along with the asymmetry parameter /g/.
  Note that the red /g/ curve does not have its own scale, imagine the
  /y/ axis going from 0 to 1 for /g/.
- a plot showing the scattering matrix elements as a function of
  scattering angle, and with sliders to go through grain sizes and
  wavelengths.  The /y/ axis of the plot is actually log_10(|F_ij|), so
  the downward peaks are actually places where the matrix element goes
  through zero.

If you want to run the plotter yourself, =ipython -i
path/to/optool_plot.py= is the correct command to do so, from the
directory where the output files are located.





* Acknowledgments
- [[http://michielmin.nl/][Michiel Min]] for the [[https://dianaproject.wp.st-andrews.ac.uk/data-results-downloads/fortran-package/][DIANA OpacityTool]] and all the incredible work
  that went into it. =optool= is a direct derivative of that tool and
  reuses almost all of its code.
- [[https://www.researchgate.net/profile/Charlene_Lefevre][Charl√©ne Lef√©vre]] for [[https://github.com/charlenelefevre/SIGMA][SIGMA]], which triggered me to add a grain mantle
  using the Maxwell-Garnett rule.
- [[http://www.ita.uni-heidelberg.de/~dullemond/index.shtml?lang=en][Kees Dullemond]] for his python plotting routine =viewarr= ([[https://github.com/dullemond/interactive_plot][available
  on github]]), and code for computing Planck and Rosseland means
  opacities.
- [[https://www.mpia.de/person/32666/1415887][Jeroen Bouwman]] for some pointers to refractive index data.

* Appendix

** Units
Due to conventions in our field, the input and output of =optool= uses
the following units
- *microns* for grain sizes and wavelengths
- *g/cm^3* for mass densities of materials
- *cm^2 g^-1* for opacities \kappa_abs, \kappa_sca, and \kappa_ext
- *sr^-1* or *cm^2 g^-1 sr^-1* for the scattering matrix elements,
  see below.
- *Kelvin* for temperatures


** Scattering Matrix: The fine print


*** Phase function normalization
:PROPERTIES:
:CUSTOM_ID: normalization
:END:
A number of different normalizations for the scattering matrix are
being used in the literature and in computational tools. The
differences are significant, and it is important to be aware of the
choice. For =optool= we are using a convention in which the average
over all directions of the 1-1 element of the scattering matrix equals
unity, i.e.

\begin{equation}
\label{eq:1}
\oint_{(4\pi)} F_{11}(\lambda,\Theta) d\Omega = 4\pi
\end{equation}

See [[https://ui.adsabs.harvard.edu/abs/2004nsm..rept....1H][Hovenier (2004)]] for a discussion of this normalization.  =optool=
can also produce output for [[http://www.ita.uni-heidelberg.de/~dullemond/software/radmc-3d/][RADMC-3D]] which uses a different
normalization, namely

\begin{equation}
\label{eq:2}
\oint_{(4\pi)} Z_{11}(\lambda,\Theta) d\Omega = \kappa_{\rm sca}(\lambda)
\end{equation}

*** Forward-scattering peak
:PROPERTIES:
:CUSTOM_ID: forward-scattering-peak
:END:

Particles that are much larger than the wavelength of the considered
radiation can show extreme forward scattering, to an extend that a
very significant fraction of the /scattered/ radiation is sent into
just a few degrees around the forward direction (scattering angle
zero).  This can be difficult to handle for radiative transfer codes
which have limited angular resolution or limited sampling.  Some codes
have an internal way to deal with this. An example would be [[http://exoclouds.com/Software/][MCMax3D]],
which has the =nspike= keyword for exactly this purpose.  Others, like
RADMC-3D require this to be taken care of by the process that creates
the opacity files.  This is the purpose of the =-chop= switch in
=optool=. It specifies a number of degrees (for example 3 might be a
good value) around the forward scattering direction. Inside that cone,
the scattering matrix gets limited to the value at the edge of the
cone.  To compensate and ensure energy conservation, the scattering
cross section will be reduced accordingly, and, depending on the
chosen normalization, the scattering matrix itself may also have to be
scaled.  As a result, in effect, the radiation that would be
/scattered/ into this narrow range of angles will be treated as if it
did have /no interaction at all/ with the grain.


*** Angular grid
:PROPERTIES:
:CUSTOM_ID: angular-grid
:END:

=optool= uses an angular grid in one degree steps from 0 to 180
degrees.  The full degrees are the cell /interfaces/ of that
grid. =optool= computes the scattering matrix at the cell /midpoints/,
i.e. at 0.5\deg, 1.5\deg etc to 179.5\deg, for a total of 180 values.
The scattering matrix is normalized in this way, so that a numerical
integral gives the correct result.

However, if you are using =optool= to produce scattering cross
sections of RADMC-3D, the conventions are different.  RADMC-3D
requires the values of the scattering matrix on the cell /boundaries/,
so at 0\deg, 1\deg etc to 180\deg, for a total of 181 values.  So for
the input files for RADMC-3D, we interpolate and extend the computed
values to the cell boundaries.  In strong forward-scattering grains,
this does require a small renormalization to make sure the the full
solid angle integration gives again accurate results. =optool= is
handling this renormalization fully automatically.

** How to ingest refractive index data for another material
Additional refractive index data tables can be compiled into the code.
Here is how:

1. Give your =lnk= file a name exactly like
   =pyr-mg70-Dorschner1995.lnk=, where =pyr-mg70= is the key to access
   the material and =Dorschner1995= (the text after the final =-=) is
   the reference.
2. Put this file into the =lnk_data= directory.
3. Optionally edit =lnk_data/lnk-help.txt=, so that =optool -c ?= will
   list the new material.  Note that, in order to define generic keys,
   optool looks for pairs like =genkey -> fullkey= in this file.
4. Run =make ingest= to update =ref_ind.f90=, now including your new
   material.
5. Recompile and install the code.

* Bibliography
- Dorschner, J. et al. 1995, A&A 300, 503
- Henning, Th. and Stognienko, R. 1996, A&A 311,291
- Hovenier, J, 2004, [[https://ui.adsabs.harvard.edu/abs/2004nsm..rept....1H][Report available on ADS]].
- J√§ger, C. et al. 1998, A&A 339, 904
- Koike, C. et al. 1995, Icarus 114, 203
- Lef√®vre, C.; Min,M. et al. 2020, A&A (submitted)
- Min, M. et al, 2005, A&A, 432, 909
- Min, M. et al. 2016, A&A, 585, 13
- Toon, O. & Ackerman,T. 1981, Applied Optics 20, 3657
- Woitke, P.; Min, M. et al. 2016, A&A 586, 103
- Preibisch, Th. et al. 1993, A&A 279, 577
- Steyer, T. 1974, PhD Thesis, The University of Arizona
- Warren, S. and Brandt,R. 2008, JGRD,113, D14220
- Zubko, V. et al. 1996, MNRAS 282,1321


# Start of Setup

#+latex_header: \usepackage{enumitem}
#+latex_header: \setlist[description]{style=nextline}
#+latex_header: \setlist[1]{noitemsep}
#+latex_header: \setlist[2]{noitemsep}
#+latex_header: \setlength\parindent{0pt}
#+latex_header: \usepackage{array}
#+latex_header: \newcolumntype{H}{>{\setbox0=\hbox\bgroup}c<{\egroup}@{}}

#+OPTIONS: toc:nil num:nil ^:t
#+LATEX_CLASS: koma-article
#+LATEX_CLASS_OPTIONS: [11pt,a4paper]

